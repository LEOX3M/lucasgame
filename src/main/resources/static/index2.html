<!DOCTYPE html>
<html>
  <head>
    <title>Juego con Jefes y Ataques Especiales</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
      }
    </style>
  </head>
  <body>
    <script>
      var selectedCharacter = 'lucas'; // Por defecto, se selecciona Lucas
		var selectedCharacter = 'lucas'; // Por defecto, se selecciona Lucas
      var player, platforms, cursors, scoreText, healthText, bossHealthText, nextLevelText;
      var stars, projectiles, playerProjectiles, bosses;
      var score = 0, playerHealth = 1, bossHealth = 2;
      var isBossActive = false, fireRate = 2000, lastFired = 0, canShoot = true, isPlayerActive = true;
      var currentLevel = 1;
     
      // Sonidos
      var shootSound, hitLucas, hitBoss, explosionSound, starSound;

      // Escena 1: Menú de selección de personaje
      class MenuScene extends Phaser.Scene {
        constructor() {
          super({ key: 'MenuScene' });
        }

        preload() {
          this.load.image('menuBackground', 'sprites/sky.png');
          this.load.image('lucasIcon', 'sprites/lucas_icon.png');
          this.load.image('rociIcon', 'sprites/roci_icon.png');
          this.load.image('startButton', 'sprites/start_button.png');
        }

        create() {
          this.add.image(window.innerWidth / 2, window.innerHeight / 2, 'menuBackground').setDisplaySize(window.innerWidth, window.innerHeight);

          // Selección de personaje
          let lucasButton = this.add.image(350, 300, 'lucasIcon').setInteractive();
          let rociButton = this.add.image(550, 300, 'rociIcon').setInteractive();
          let startButton = this.add.image(window.innerWidth / 2, window.innerHeight - 100, 'startButton').setInteractive();

          // Eventos para seleccionar personajes
          lucasButton.on('pointerdown', () => {
            selectedCharacter = 'lucas';
          });

          rociButton.on('pointerdown', () => {
            selectedCharacter = 'roci';
          });

          // Iniciar el juego
          startButton.on('pointerdown', () => {
			isPlayerActive = true;
            this.scene.start('GameScene');
          });

          this.add.text(250, 100, 'Selecciona tu personaje', { fontSize: '32px', fill: '#fff' });
        }
      }

      // Escena 2: Juego principal
      class GameScene extends Phaser.Scene {
        constructor() {
          super({ key: 'GameScene' });
        }

        preload() {
          this.load.image('sky', 'sprites/sky.png');
          this.load.image('ground', 'sprites/ground.png');
          this.load.image('star', 'sprites/star.png');
          this.load.spritesheet('lucas', 'sprites/lucas_spritesheet.png', { frameWidth: 32, frameHeight: 48 });
          this.load.spritesheet('roci', 'sprites/roci_spritesheet.png', { frameWidth: 32, frameHeight: 48 });
          this.load.spritesheet('boss', 'sprites/boss.png', { frameWidth: 32, frameHeight: 48 });
          this.load.image('projectile', 'sprites/projectile.png');
          this.load.image('playerProjectile', 'sprites/player-projectile.png');
          this.load.audio('shootSound', 'sounds/shoot.mp3');
          this.load.audio('hitLucas', 'sounds/hit-lucas.mp3');
          this.load.audio('hitBoss', 'sounds/hit-boss.mp3');
          this.load.audio('explosionSound', 'sounds/explosion.mp3');
          this.load.audio('starSound', 'sounds/star.mp3');
        }

        create() {
          this.add.image(window.innerWidth / 2, window.innerHeight / 2, 'sky').setDisplaySize(window.innerWidth, window.innerHeight);

          platforms = this.physics.add.staticGroup();
          platforms.create(1150, window.innerHeight - 64, 'ground');
          platforms.create(700, window.innerHeight - 16, 'ground');
          platforms.create(250, window.innerHeight - 64, 'ground');
          platforms.create(1150, 180, 'ground');
          platforms.create(50, 380, 'ground');
          platforms.create(650, 500, 'ground');
          platforms.create(850, 300, 'ground');

          // Crear jugador según el personaje seleccionado
          if (selectedCharacter === 'lucas') {
            player = this.physics.add.sprite(100, window.innerHeight - 150, 'lucas');
          } else {
            player = this.physics.add.sprite(100, window.innerHeight - 150, 'roci');
          }

          player.setBounce(0.2);
          player.setCollideWorldBounds(true);

          this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers(selectedCharacter, { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
          });

          this.anims.create({
            key: 'turn',
            frames: [{ key: selectedCharacter, frame: 4 }],
            frameRate: 20
          });

          this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers(selectedCharacter, { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
          });

          stars = this.physics.add.group({
            key: 'star',
            repeat: 1,
            setXY: { x: 12, y: 0, stepX: 70 }
          });

          stars.children.iterate(function (child) {
            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));
          });

          projectiles = this.physics.add.group();
          playerProjectiles = this.physics.add.group();
          bosses = this.physics.add.group();

          scoreText = this.add.text(16, 16, 'Puntaje: 0', { fontSize: '32px', fill: '#000' });
          healthText = this.add.text(16, 50, 'Vida: ' + playerHealth, { fontSize: '32px', fill: '#ff0000' });
          bossHealthText = this.add.text(window.innerWidth - 400, 16, 'Vidas Pazita: ' + bossHealth, { fontSize: '32px', fill: '#ff0000' });
		  nextLevelText = this.add.text(window.innerWidth / 2 - 100, window.innerHeight / 2, '', { fontSize: '32px', fill: '#00ff00' }).setVisible(false);

          this.physics.add.collider(player, platforms);
          this.physics.add.collider(stars, platforms);
          this.physics.add.collider(bosses, platforms);
          this.physics.add.overlap(player, stars, collectStar, null, this);
          this.physics.add.collider(bosses, playerProjectiles, playerProjectileHitBoss, null, this);
          this.physics.add.collider(player, projectiles, projectileHitPlayer, null, this);
          this.physics.add.collider(player, bosses, bossAttack, null, this);
          
          // Cargar sonidos
          shootSound = this.sound.add('shootSound');
          hitLucas = this.sound.add('hitLucas');
          hitBoss = this.sound.add('hitBoss');
          explosionSound = this.sound.add('explosionSound');
          starSound = this.sound.add('starSound');

          cursors = this.input.keyboard.createCursorKeys();
        }

        update(time) {
		if(isPlayerActive){
          if (cursors.left.isDown) {
            player.setVelocityX(-260);
            player.anims.play('left', true);
          } else if (cursors.right.isDown) {
            player.setVelocityX(260);
            player.anims.play('right', true);
          } else {
            player.setVelocityX(0);
            player.anims.play('turn');
          }

          if (cursors.up.isDown && player.body.touching.down) {
            player.setVelocityY(-330);
          }

          if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE)) && canShoot) {
            firePlayerProjectile(this);
            canShoot = false;
            setTimeout(() => canShoot = true, 500);
          }
         }

          if (isBossActive) {
            if (boss.body.velocity.x === 0) {
              boss.setVelocityX(10);
            }
            if (boss.body.touching.down && Phaser.Math.Between(0, 100) < 20) {
              boss.setVelocityY(-400);
            }
            if (time > lastFired) {
              fireProjectile(this);
              lastFired = time + fireRate;
            }
          }
        }

        gameOver() {
          this.scene.transition({
			    target: 'MenuScene',      // Escena de destino
			    duration: 4000,           // Duración de la transición (en milisegundos)
			    onUpdate: (progress) => {
			        console.log(progress);  // Puedes hacer algo mientras transiciona
			    }
			});
        }
      }
      
       function collectStar(player, star) {
          star.disableBody(true, true);

          score += 10;
          scoreText.setText('Puntaje: ' + score);
          
          starSound.play();

          if (stars.countActive(true) === 0) {
              if (!isBossActive) {
                  spawnBoss(this);  // Aparecer el jefe cuando se recojan todas las estrellas
              }
          }
      }

      function spawnBoss(scene) {
          // Aparecer el jefe final
          boss = scene.physics.add.sprite(window.innerWidth / 2, window.innerHeight / 2, 'boss');
          bosses.add(boss);
          
          boss.setCollideWorldBounds(true);
          boss.setBounce(1);
          boss.setVelocityX(100);
          isBossActive = true;
      }


      function bossAttack(player, boss) {
          // El jefe ataca al jugador y le quita vida
          playerHealth -= 1;
          healthText.setText('Vida: ' + playerHealth);

          if (playerHealth <= 0) {
				isPlayerActive = false;
				isBossActive = false;
			  	this.physics.pause();
			  	player.setTint(0xff0000);
			  	player.anims.play('turn');
			  	nextLevelText.setText('Game Over Looser!').setVisible(true);
			  
			   this.scene.transition({
			    target: 'MenuScene',      // Escena de destino
			    duration: 1000,           // Duración de la transición (en milisegundos)
			    onUpdate: (progress) => {
			        console.log(progress);  // Puedes hacer algo mientras transiciona
			    }
				});
          }

          // Reducir la vida del jefe
          bossHealth -= 1;
          bossHealthText.setText('Vida Pazita: ' + bossHealth);

          if (bossHealth <= 0) {
              explosionSound.play();
              boss.disableBody(true, true);
              isBossActive = false;
              currentLevel++;
              nextLevelText.setText('Nivel ' + currentLevel + ' Completado!').setVisible(true);
              setTimeout(() => {
                  nextLevelText.setVisible(false);
                  goToNextLevel(this);  // Pasar al siguiente nivel
              }, 4000);
          }
      }

      // Función para disparar proyectiles desde el jefe hacia el jugador
      function fireProjectile(scene) {
          var projectile = scene.physics.add.image(boss.x, boss.y, 'projectile');
          projectiles.add(projectile);

          // Hacer que el proyectil siga al jugador
          scene.physics.moveToObject(projectile, player, 200);

          // Reproducir sonido de disparo
          shootSound.play();
      }

      function firePlayerProjectile(scene) {
		if(isBossActive){
	          var playerProjectile = scene.physics.add.image(player.x, player.y, 'playerProjectile');
	          playerProjectiles.add(playerProjectile);
	
	          // Hacer que el proyectil siga al jefe
	          scene.physics.moveToObject(playerProjectile, boss, 300);
	
	          // Reproducir sonido de disparo del jugador
	          shootSound.play();
          }
      }

      function destroyProjectile(projectile) {
          projectile.destroy();  // Destruir proyectil al colisionar
      }

      // Impacto del proyectil del jugador en el jefe
      function playerProjectileHitBoss(boss, playerProjectile) {
          playerProjectile.destroy();
          bossHealth -= 1;  // Reducir la vida del jefe
          bossHealthText.setText('Vida Pazita: ' + bossHealth);  // Actualizar la vida del jefe

          hitBoss.play();  // Reproducir sonido de impacto

          if (bossHealth <= 0) {
				isBossActive = false;
              explosionSound.play();  // Reproducir sonido de explosión
             	boss.disableBody(true, true);  // Jefe derrotado
              boss.destroy();
              nextLevelText.setText('Nivel ' + currentLevel + ' Completado!').setVisible(true);
              setTimeout(() => {
                  nextLevelText.setVisible(false);
                  goToNextLevel(this);  // Pasar al siguiente nivel
              }, 2000);
          }
      }

      function projectileHitPlayer(player, projectile) {
          projectile.destroy();
          playerHealth -= 1;
          healthText.setText('Vida: ' + playerHealth);
          hitLucas.play();  // Reproducir sonido de impacto

          if (playerHealth <= 0) {
			isPlayerActive = false;
			isBossActive = false;
		  	this.physics.pause();
		  	player.setTint(0xff0000);
		  	player.anims.play('turn');
		  	nextLevelText.setText('Game Over Looser!').setVisible(true);
		  
		   this.scene.transition({
		    target: 'MenuScene',      // Escena de destino
		    duration: 1000,           // Duración de la transición (en milisegundos)
		    onUpdate: (progress) => {
		        console.log(progress);  // Puedes hacer algo mientras transiciona
		    }
			});
              
          }
      }

      function goToNextLevel(scene) {
          // Resetear el nivel y los elementos del juego
          bossHealth = 10;  // Reiniciar la vida del jefe
          playerHealth = 2;
          healthText.setText('Vida: ' + playerHealth);
          bossHealthText.setText('Vida Pazita: ' + bossHealth);

          // Reiniciar las estrellas para el próximo nivel
          stars.children.iterate(function (child) {
              child.enableBody(true, child.x, 0, true, true);
          });

      }
      
      function goToGameOver(){
			isPlayerActive = false;
			isBossActive = false;
		  	this.physics.pause();
		  	player.setTint(0xff0000);
		  	player.anims.play('turn');
		  	nextLevelText.setText('Game Over Looser!').setVisible(true);
		  
		   this.scene.transition({
		    target: 'MenuScene',      // Escena de destino
		    duration: 1000,           // Duración de la transición (en milisegundos)
		    onUpdate: (progress) => {
		        console.log(progress);  // Puedes hacer algo mientras transiciona
		    }
			});
	}
      
       // Configuración general del juego
      var config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 350 },
            debug: false
          }
        },
        scene: [MenuScene, GameScene]
      };

      var game = new Phaser.Game(config);

    </script>
  </body>
</html>
