<!DOCTYPE html>
<html>
  <head>
    <title>Juego de Plataforma con Jefe</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.55.2/phaser.min.js"></script>
    <style>
      body, html {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #000;
      }
    </style>
  </head>
  <body>
    <script>
      var config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        physics: {
          default: 'arcade',
          arcade: {
            gravity: { y: 300 },
            debug: false
          }
        },
        scene: {
          preload: preload,
          create: create,
          update: update
        }
      };

      var player;
      var platforms;
      var stars;
      var cursors;
      var score = 0;
      var scoreText;
      var isBossBattle = false;
      var boss;
      var bossHealth = 10;
      var bossHealthText;
      var playerHealth = 3;
      var playerHealthText;
      var bossProjectiles;
      var playerProjectiles;
      var nextPlatformX = 0;
      var canShoot = true;

      var game = new Phaser.Game(config);

      function preload() {
        this.load.image('sky', 'sprites/sky.png');
        this.load.image('ground', 'sprites/ground.png');
        this.load.image('star', 'sprites/star.png');
        this.load.image('boss', 'sprites/boss1.png');
        this.load.spritesheet('dude', 'sprites/dude.png', { frameWidth: 32, frameHeight: 48 });
        this.load.image('projectile', 'sprites/projectile.png');  // Proyectil del jefe
        this.load.image('playerProjectile', 'sprites/player-projectile.png');  // Proyectil del jugador
      }

      function create() {
        // Fondo
        this.add.image(window.innerWidth / 2, window.innerHeight / 2, 'sky').setDisplaySize(window.innerWidth, window.innerHeight);

        // Plataforma inicial
        platforms = this.physics.add.staticGroup();
        platforms.create(100, window.innerHeight - 32, 'ground').setScale(2).refreshBody();
        
        // Jugador
        player = this.physics.add.sprite(100, window.innerHeight - 150, 'dude');
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);

        this.anims.create({
          key: 'left',
          frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
          frameRate: 10,
          repeat: -1
        });

        this.anims.create({
          key: 'turn',
          frames: [ { key: 'dude', frame: 4 } ],
          frameRate: 20
        });

        this.anims.create({
          key: 'right',
          frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
          frameRate: 10,
          repeat: -1
        });

        // Grupo de estrellas
        stars = this.physics.add.group();

        // Colisiones entre el jugador y las plataformas
        this.physics.add.collider(player, platforms);

        // Puntuación
        scoreText = this.add.text(16, 16, 'Stars: 0', { fontSize: '32px', fill: '#000' });

        // Vidas del jugador
        playerHealthText = this.add.text(16, 50, 'Health: ' + playerHealth, { fontSize: '32px', fill: '#ff0000' });

        // Hacer que el jugador avance automáticamente
        player.setVelocityX(160);

        cursors = this.input.keyboard.createCursorKeys();

        // Colisión entre el jugador y las estrellas
        this.physics.add.overlap(player, stars, collectStar, null, this);

        // Grupo de proyectiles del jefe
        bossProjectiles = this.physics.add.group();
        this.physics.add.collider(bossProjectiles, platforms, destroyProjectile, null, this);

        // Grupo de proyectiles del jugador
        playerProjectiles = this.physics.add.group();
        this.physics.add.collider(playerProjectiles, platforms, destroyProjectile, null, this);
        this.physics.add.collider(playerProjectiles, boss, playerProjectileHitBoss, null, this);

        // Colisiones con el jugador y proyectiles del jefe
        this.physics.add.collider(player, bossProjectiles, projectileHitPlayer, null, this);
      }

      function update(time) {
        // Si no es batalla de jefe, seguir generando plataformas y estrellas
        if (!isBossBattle) {
          // Generación de plataformas aleatorias
          if (nextPlatformX < player.x + window.innerWidth) {
            createRandomPlatform(this);
            nextPlatformX += Phaser.Math.Between(300, 600); // Distancia entre plataformas
          }

          if (cursors.up.isDown && player.body.touching.down) {
            player.setVelocityY(-330);
          }
        }

        // Si el jugador recolecta 10 estrellas, comienza la batalla del jefe
        if (score >= 10 && !isBossBattle) {
          startBossBattle(this);
        }

        // Permitir que el jugador dispare proyectiles durante la batalla con el jefe
        if (isBossBattle && Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE)) && canShoot) {
          firePlayerProjectile(this);
          canShoot = false;
          setTimeout(() => canShoot = true, 500); // El jugador puede disparar cada 0.5 segundos
        }
      }

      function createRandomPlatform(scene) {
        var y = Phaser.Math.Between(200, window.innerHeight - 100);
        var platform = platforms.create(nextPlatformX, y, 'ground').setScale(1).refreshBody();

        // Generar estrellas sobre la plataforma
        if (Phaser.Math.Between(0, 100) < 50) { // 50% de probabilidad de que aparezca una estrella
          var star = stars.create(nextPlatformX, y - 50, 'star');
        }
      }

      function collectStar(player, star) {
        star.disableBody(true, true);
        score += 1;
        scoreText.setText('Stars: ' + score);

        if (score >= 10) {
          // Iniciar batalla de jefe
          startBossBattle(this);
        }
      }

      function startBossBattle(scene) {
        isBossBattle = true;

        // Detener el movimiento continuo del jugador
        player.setVelocityX(0);

        // Aparecer el jefe
        boss = scene.physics.add.sprite(window.innerWidth / 2, window.innerHeight / 2, 'boss');
        boss.setCollideWorldBounds(true);
        bossHealthText = scene.add.text(window.innerWidth - 200, 16, 'Boss Health: ' + bossHealth, { fontSize: '32px', fill: '#ff0000' });

        // Jefe comienza a atacar
        scene.time.addEvent({
          delay: 2000,  // Dispara proyectiles cada 2 segundos
          callback: function() {
            fireBossProjectile(scene);
          },
          loop: true
        });
      }

      function fireBossProjectile(scene) {
        var projectile = scene.physics.add.image(boss.x, boss.y, 'projectile');
        bossProjectiles.add(projectile);
        scene.physics.moveToObject(projectile, player, 200);
      }

      // El jugador dispara proyectiles hacia el jefe
      function firePlayerProjectile(scene) {
        var playerProjectile = scene.physics.add.image(player.x, player.y, 'playerProjectile');
        playerProjectiles.add(playerProjectile);
        scene.physics.moveToObject(playerProjectile, boss, 400);
      }

      function playerProjectileHitBoss(boss, playerProjectile) {
        playerProjectile.destroy();
        bossHealth -= 1;
        bossHealthText.setText('Boss Health: ' + bossHealth);

        if (bossHealth <= 0) {
          boss.disableBody(true, true);
          scene.add.text(window.innerWidth / 2 - 100, window.innerHeight / 2, '¡Jefe Derrotado!', { fontSize: '32px', fill: '#00ff00' });
        }
      }

      function destroyProjectile(projectile) {
        projectile.destroy();
      }

      function projectileHitPlayer(player, projectile) {
        projectile.destroy();
        playerHealth -= 1;
        playerHealthText.setText('Health: ' + playerHealth);

        if (playerHealth <= 0) {
          this.physics.pause();
          player.setTint(0xff0000);
          player.anims.play('turn');
          scene.add.text(window.innerWidth / 2 - 100, window.innerHeight / 2, '¡Game Over!', { fontSize: '32px', fill: '#ff0000' });
        }
      }
    </script>
  </body>
</html>
